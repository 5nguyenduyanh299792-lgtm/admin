<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OCEAN EDU RESEARCH ADMIN</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        :root {
            --primary: #00c6ff;
            --primary-dark: #0072ff;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --text: #0f172a;
            --text-light: #64748b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; }

        body {
            background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
            min-height: 100vh; color: var(--text);
            padding-bottom: 80px; overflow-x: hidden;
        }

        /* HEADER */
        .header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);
            border-bottom: 1px solid white; padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .logo { font-size: 20px; font-weight: 800; color: var(--primary-dark); display: flex; align-items: center; gap: 8px; }
        .nav-tabs { display: flex; gap: 8px; background: #f1f5f9; padding: 5px; border-radius: 50px; }
        .tab-btn {
            padding: 8px 20px; border-radius: 40px; border: none; background: transparent; 
            color: var(--text-light); font-weight: 700; cursor: pointer; transition: 0.3s;
        }
        .tab-btn.active { background: white; color: var(--primary-dark); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        /* CONTAINERS */
        .view-section { display: none; padding: 30px; max-width: 1200px; margin: 0 auto; animation: fadeUp 0.5s ease; }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* TABLE STYLE (Table 3.1) */
        .data-table {
            width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 30px;
        }
        .data-table th, .data-table td { padding: 12px 20px; text-align: left; border-bottom: 1px solid #f1f5f9; }
        .data-table th { background: #f8fafc; color: var(--primary-dark); font-weight: 800; text-transform: uppercase; font-size: 13px; }
        .data-table tr:last-child td { border-bottom: none; }
        .dt-category { font-weight: 700; color: var(--text); background: #f1f5f9; }
        
        /* CHART GRID */
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px; }
        .chart-card {
            background: white; border-radius: 20px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.5);
        }
        .chart-header {
            font-size: 16px; font-weight: 800; color: var(--text); margin-bottom: 20px;
            padding-bottom: 10px; border-bottom: 2px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }
        .chart-desc { font-size: 13px; color: var(--text-light); font-weight: 400; margin-top: 5px; }

        /* LOADING */
        #loader {
            position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top-color: var(--primary-dark);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        @media(max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .header { padding: 15px; }
            .view-section { padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo"><i class="ri-survey-line"></i> RESEARCH ADMIN</div>
        <div class="nav-tabs">
            <button class="tab-btn" onclick="alert('Tính năng xem chi tiết đã ẩn để tập trung vào báo cáo!')">Phiếu</button>
            <button class="tab-btn active">Báo Cáo</button>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <div style="margin-top:15px; font-weight:700; color:#0072ff">ĐANG TÍNH TOÁN SỐ LIỆU...</div>
    </div>

    <!-- VIEW REPORT -->
    <div id="view-stats" class="view-section active">
        
        <!-- 1. TABLE 3.1 -->
        <div class="chart-card" style="max-width: 800px; margin: 0 auto 30px auto;">
            <div class="chart-header">
                <div>
                    Table 3.1: Demographic Profiles
                    <div class="chart-desc">Thống kê mô tả về người tham gia (N = <span id="totalN">0</span>)</div>
                </div>
                <i class="ri-table-line" style="font-size: 24px; color: var(--primary-dark)"></i>
            </div>
            <table class="data-table">
                <thead><tr><th>Category</th><th>Sub-category</th><th>Frequency (n)</th><th>Percentage (%)</th></tr></thead>
                <tbody id="demoTableBody"></tbody>
            </table>
        </div>

        <div class="charts-grid">
            
            <!-- 2. CHART 3.1: Item Analysis -->
            <div class="chart-card" style="grid-column: span 1/-1;">
                <div class="chart-header">
                    <div>
                        Chart 3.1: Item-level Analysis of Motivation
                        <div class="chart-desc">Điểm trung bình (Mean) của từng câu hỏi (Thang đo 1-5)</div>
                    </div>
                </div>
                <div style="height: 350px;"><canvas id="chartItemAnalysis"></canvas></div>
            </div>

            <!-- 3. CHART 3.2: Intrinsic vs Extrinsic -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>Chart 3.2: Intrinsic vs. Extrinsic</div>
                    <div class="chart-desc">So sánh hai nguồn động lực chính (RQ1)</div>
                </div>
                <canvas id="chartCompareMotiv"></canvas>
            </div>

            <!-- 4. CHART 3.3: Internal Barriers -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>Chart 3.3: Psychological Barriers</div>
                    <div class="chart-desc">Yếu tố tâm lý: Ngại, Sợ sai, Niềm tin</div>
                </div>
                <canvas id="chartInternal"></canvas>
            </div>

            <!-- 5. CHART 3.4: External Factors -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>Chart 3.4: Learning Environment Impact</div>
                    <div class="chart-desc">Tác động của Giáo viên, Thiết bị, Video...</div>
                </div>
                <canvas id="chartExternal"></canvas>
            </div>

            <!-- 6. CHART 3.5: Activities -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>Chart 3.5: Student Preferences</div>
                    <div class="chart-desc">Số lượt bình chọn cho các hoạt động</div>
                </div>
                <canvas id="chartActivities"></canvas>
            </div>

            <!-- 7. CHART 3.6: Feedback -->
            <div class="chart-card" style="grid-column: span 1/-1;">
                <div class="chart-header">
                    <div>Chart 3.6: Categorization of Feedback</div>
                    <div class="chart-desc">Phân tích nội dung ý kiến đóng góp</div>
                </div>
                <canvas id="chartFeedback" height="100"></canvas>
            </div>
        </div>
    </div>

    <script>
        // === PASTE LINK SCRIPT CỦA BẠN VÀO DƯỚI ĐÂY ===
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyg7-yAjQoN9NcU7VO5_iB1LHtLKBmWbGLrdKkpymuRcBEMoNLBBhVmYZVz_4ihhlcEzg/exec'; 

        // CONFIG & MAPPING
        const headerMap = {
            Age: 'Age', Gender: 'Gender', Duration: 'Duration',
            A1: 'A1', A2: 'A2', A3: 'A3',
            B1: 'B1', B2: 'B2', B3: 'B3',
            C1: 'C1', C2: 'C2', C3: 'C3',
            D1: 'D1', D2: 'D2', D3: 'D3', D4: 'D4',
            Activities: 'Activities', Feedback: 'Feedback'
        };

        const questionLabels = {
            A1: "A1. Thích diễn đạt", A2: "A2. Vui vẻ khi nói", A3: "A3. Muốn hiểu văn hóa",
            B1: "B1. Điểm số/Thưởng", B2: "B2. Kỳ vọng của Cha mẹ", B3: "B3. Công việc/Du học",
            C1: "C1. Lo lắng/Ngại (Shyness)", C2: "C2. Sợ mắc lỗi (Fear)", C3: "C3. Tin bản thân (Belief)",
            D1: "D1. Giáo viên hỗ trợ", D2: "D2. Thiết bị hiện đại", D3: "D3. Hoạt động quay Video", D4: "D4. Nhóm bạn tốt"
        };

        let rawData = [], headers = [];

        // --- HELPER FUNCTIONS ---
        // Tìm index cột thông minh (cho dù tên cột trong sheet có thay đổi xíu)
        const getCol = (key) => {
            let idx = headers.findIndex(h => h.toString().trim() === key || h.toString().trim().startsWith(key + "_") || h.toString().trim().startsWith(key));
            return idx;
        };

        const getColData = (key) => {
            const idx = getCol(key);
            if (idx === -1) return [];
            return rawData.map(r => r[idx]);
        };

        const calcMean = (keys) => {
            let sum = 0, count = 0;
            keys.forEach(k => {
                const vals = getColData(k);
                vals.forEach(v => {
                    const num = parseInt(v);
                    if (!isNaN(num)) { sum += num; count++; }
                });
            });
            return count ? (sum / count).toFixed(2) : 0;
        };

        const countValues = (arr) => {
            const counts = {};
            arr.forEach(x => { if(x) counts[x] = (counts[x] || 0) + 1; });
            return counts;
        };

        // --- MAIN ---
        window.onload = async () => {
            try {
                const res = await fetch(scriptURL);
                const data = await res.json();
                
                headers = data[0];
                rawData = data.slice(1);
                
                const N = rawData.length;
                document.getElementById('totalN').innerText = N;
                document.getElementById('loader').style.display = 'none';

                // --- 1. TABLE 3.1: DEMOGRAPHICS ---
                renderDemographicTable(N);

                // --- 2. CHART 3.1: ITEM ANALYSIS (GROUPED BAR) ---
                const meansA = ['A1','A2','A3'].map(k => calcMean([k]));
                const meansB = ['B1','B2','B3'].map(k => calcMean([k]));
                
                renderChart('chartItemAnalysis', 'bar', {
                    labels: ['Item 1', 'Item 2', 'Item 3'],
                    datasets: [
                        { label: 'Intrinsic (Bên trong)', data: meansA, backgroundColor: '#00c6ff', borderRadius: 5 },
                        { label: 'Extrinsic (Bên ngoài)', data: meansB, backgroundColor: '#f59e0b', borderRadius: 5 }
                    ]
                }, { scales: {y: {min: 1, max: 5, title: {display: true, text: 'Mean Score'}}} });

                // --- 3. CHART 3.2: INTRINSIC VS EXTRINSIC (COMPARISON) ---
                const meanIntrinsic = calcMean(['A1','A2','A3']);
                const meanExtrinsic = calcMean(['B1','B2','B3']);

                renderChart('chartCompareMotiv', 'bar', {
                    labels: ['Intrinsic Motivation', 'Extrinsic Motivation'],
                    datasets: [{
                        label: 'Mean Score',
                        data: [meanIntrinsic, meanExtrinsic],
                        backgroundColor: ['#00c6ff', '#f59e0b'],
                        barPercentage: 0.6, borderRadius: 8
                    }]
                }, { 
                    indexAxis: 'y', 
                    scales: {x: {min: 1, max: 5}},
                    plugins: { legend: {display: false} }
                });

                // --- 4. CHART 3.3: INTERNAL FACTORS (HORIZONTAL BAR) ---
                const meansC = ['C1','C2','C3'].map(k => calcMean([k]));
                renderChart('chartInternal', 'bar', {
                    labels: ['C1. Shyness (Ngại)', 'C2. Fear of Mistakes (Sợ sai)', 'C3. Self-Belief (Niềm tin)'],
                    datasets: [{
                        label: 'Mean Level',
                        data: meansC,
                        backgroundColor: ['#ef4444', '#f97316', '#10b981'],
                        borderRadius: 5
                    }]
                }, { indexAxis: 'y', scales: {x: {min: 1, max: 5}} });

                // --- 5. CHART 3.4: EXTERNAL FACTORS (MEAN BAR) ---
                const meansD = ['D1','D2','D3','D4'].map(k => calcMean([k]));
                renderChart('chartExternal', 'bar', {
                    labels: ['Teacher Support', 'Modern Equipment', 'Video Recording', 'Peer/Group'],
                    datasets: [{
                        label: 'Impact Score',
                        data: meansD,
                        backgroundColor: '#0072ff',
                        borderRadius: 5
                    }]
                }, { scales: {y: {min: 1, max: 5}} });

                // --- 6. CHART 3.5: ACTIVITIES (FREQUENCY) ---
                const actRaw = getColData('Activities');
                const actCounts = {};
                actRaw.forEach(s => {
                    if(s) s.toString().split(', ').forEach(a => actCounts[a] = (actCounts[a]||0) + 1);
                });
                const sortedActs = Object.entries(actCounts).sort((a,b) => b[1] - a[1]);

                renderChart('chartActivities', 'bar', {
                    labels: sortedActs.map(x => x[0]),
                    datasets: [{
                        label: 'Number of Votes',
                        data: sortedActs.map(x => x[1]),
                        backgroundColor: '#8b5cf6',
                        borderRadius: 5
                    }]
                }, {});

                // --- 7. CHART 3.6: FEEDBACK CATEGORIZATION ---
                const fbRaw = getColData('Feedback').filter(f => f);
                const categories = {
                    "More Games": 0, "Outdoor Activities": 0, "Speaking/Foreign Teachers": 0, 
                    "Less Homework/Slower": 0, "General Praise/No Idea": 0
                };
                
                fbRaw.forEach(f => {
                    const t = f.toLowerCase();
                    if(t.includes('game') || t.includes('trò chơi')) categories["More Games"]++;
                    else if(t.includes('outdoor') || t.includes('ngoài trời')) categories["Outdoor Activities"]++;
                    else if(t.includes('speak') || t.includes('nói') || t.includes('nước ngoài')) categories["Speaking/Foreign Teachers"]++;
                    else if(t.includes('homework') || t.includes('bài tập') || t.includes('chậm') || t.includes('nhanh')) categories["Less Homework/Slower"]++;
                    else categories["General Praise/No Idea"]++;
                });

                renderChart('chartFeedback', 'bar', {
                    labels: Object.keys(categories),
                    datasets: [{
                        label: 'Mentions',
                        data: Object.values(categories),
                        backgroundColor: '#ec4899',
                        borderRadius: 5
                    }]
                }, { indexAxis: 'y' });

            } catch (err) {
                console.error(err);
                alert("Lỗi tải dữ liệu. Kiểm tra lại Link Script!");
            }
        };

        // --- RENDER FUNCTIONS ---
        function renderDemographicTable(N) {
            const tbody = document.getElementById('demoTableBody');
            const addRow = (cat, sub, count) => {
                const pct = ((count / N) * 100).toFixed(1);
                tbody.innerHTML += `<tr>${cat ? `<td rowspan="99" class="dt-category">${cat}</td>` : ''}<td>${sub}</td><td>${count}</td><td>${pct}%</td></tr>`;
            };

            // AGE
            const ageData = countValues(getColData('Age'));
            tbody.innerHTML += `<tr><td rowspan="3" class="dt-category">Age Group</td><td>12-13 years old</td><td>${ageData['12-13']||0}</td><td>${((ageData['12-13']||0)/N*100).toFixed(1)}%</td></tr>`;
            tbody.innerHTML += `<tr><td>14-15 years old</td><td>${ageData['14-15']||0}</td><td>${((ageData['14-15']||0)/N*100).toFixed(1)}%</td></tr>`;
            tbody.innerHTML += `<tr><td>16 years old</td><td>${ageData['16']||0}</td><td>${((ageData['16']||0)/N*100).toFixed(1)}%</td></tr>`;

            // GENDER
            const genData = countValues(getColData('Gender'));
            tbody.innerHTML += `<tr><td rowspan="2" class="dt-category">Gender</td><td>Male</td><td>${genData['Male']||0}</td><td>${((genData['Male']||0)/N*100).toFixed(1)}%</td></tr>`;
            tbody.innerHTML += `<tr><td>Female</td><td>${genData['Female']||0}</td><td>${((genData['Female']||0)/N*100).toFixed(1)}%</td></tr>`;

            // DURATION
            const durData = countValues(getColData('Duration'));
            tbody.innerHTML += `<tr><td rowspan="3" class="dt-category">Learning Duration</td><td>Under 6 months</td><td>${durData['<6m']||0}</td><td>${((durData['<6m']||0)/N*100).toFixed(1)}%</td></tr>`;
            tbody.innerHTML += `<tr><td>6 months - 1 year</td><td>${durData['6m-1y']||0}</td><td>${((durData['6m-1y']||0)/N*100).toFixed(1)}%</td></tr>`;
            tbody.innerHTML += `<tr><td>Over 1 year</td><td>${durData['>1y']||0}</td><td>${((durData['>1y']||0)/N*100).toFixed(1)}%</td></tr>`;
        }

        function renderChart(id, type, data, options) {
            Chart.defaults.font.family = 'Quicksand';
            Chart.defaults.color = '#475569';
            new Chart(document.getElementById(id), {
                type: type,
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        datalabels: {
                            color: 'white', font: {weight:'bold'},
                            formatter: (v) => v, anchor: 'end', align: 'start', offset: -20
                        }
                    },
                    ...options
                },
                plugins: [ChartDataLabels]
            });
        }
    </script>
</body>
</html>
