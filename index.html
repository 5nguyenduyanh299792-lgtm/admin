<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OCEAN EDU RESEARCH DASHBOARD</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

    <style>
        :root {
            --primary: #00c6ff;
            --primary-dark: #0072ff;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --text: #0f172a;
            --text-light: #64748b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Quicksand', sans-serif; }

        body {
            background: linear-gradient(135deg, #00c6ff 0%, #0072ff 100%);
            min-height: 100vh; color: var(--text); padding-bottom: 80px; overflow-x: hidden;
        }

        /* HEADER */
        .header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px);
            border-bottom: 1px solid white; padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .logo { font-size: 20px; font-weight: 800; color: var(--primary-dark); display: flex; align-items: center; gap: 10px; }
        
        .nav-tabs { display: flex; gap: 8px; background: #f1f5f9; padding: 5px; border-radius: 50px; }
        .tab-btn {
            padding: 8px 20px; border-radius: 40px; border: none; background: transparent; color: var(--text-light);
            font-weight: 700; cursor: pointer; transition: 0.3s; font-size: 14px; display: flex; gap: 6px; align-items: center;
        }
        .tab-btn.active { background: white; color: var(--primary-dark); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        /* CONTAINERS */
        .view-section { display: none; padding: 30px; max-width: 1200px; margin: 0 auto; animation: fadeUp 0.5s ease; }
        .view-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* RESEARCH TABLES & CHARTS STYLES */
        .section-title {
            font-size: 18px; font-weight: 800; color: white; margin: 40px 0 20px 0;
            text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 10px;
        }
        
        .research-card {
            background: white; border-radius: 20px; padding: 25px; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 2px solid rgba(255,255,255,0.5);
        }
        .chart-header {
            font-size: 16px; font-weight: 700; color: var(--primary-dark); margin-bottom: 20px;
            padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; display: flex; justify-content: space-between;
        }

        /* TABLE 3.1 STYLE */
        .demo-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .demo-table th { background: #f1f5f9; color: var(--primary-dark); padding: 12px; text-align: left; font-weight: 800; }
        .demo-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: var(--text); }
        .demo-table tr:last-child td { border-bottom: none; }
        .badge { background: #e0f2fe; color: var(--primary-dark); padding: 4px 10px; border-radius: 20px; font-weight: 700; font-size: 12px; }

        /* VIEW 1 STYLES (KEEPING SIMPLE) */
        .response-card { background: var(--glass-bg); border-radius: 30px; display: flex; overflow: hidden; min-height: 70vh; box-shadow: 0 20px 60px rgba(0,0,0,0.1); }
        .profile-sidebar { width: 300px; background: #f8fafc; padding: 30px; text-align: center; border-right: 1px solid #e2e8f0; }
        .answer-area { flex: 1; padding: 20px; overflow-y: auto; height: 70vh; }
        .avatar { width: 100px; height: 100px; background: white; border-radius: 50%; margin: 0 auto 20px; display: flex; justify-content: center; align-items: center; font-size: 40px; color: var(--primary-dark); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        
        /* LOADING */
        #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        @media(max-width: 768px) {
            .response-card { flex-direction: column; height: auto; }
            .profile-sidebar { width: 100%; border-right: none; border-bottom: 1px solid #e2e8f0; }
        }
    </style>
</head>
<body>

    <!-- HEADER -->
    <div class="header">
        <div class="logo"><i class="ri-article-line"></i> OCEAN RESEARCH</div>
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('detail')"><i class="ri-file-search-line"></i> Raw Data</button>
            <button class="tab-btn" onclick="switchTab('stats')"><i class="ri-bar-chart-grouped-line"></i> Research Analysis</button>
        </div>
    </div>

    <!-- LOADING -->
    <div id="loader">
        <div style="font-weight: 800; font-size: 20px; color: var(--primary-dark);">LOADING DATA...</div>
    </div>

    <!-- === VIEW 1: RAW DATA (CHI TIẾT PHIẾU) === -->
    <div id="view-detail" class="view-section active">
        <div class="research-card" style="background: rgba(255,255,255,0.2); border: none; box-shadow: none;">
            <div class="response-card">
                <div class="profile-sidebar">
                    <div class="avatar" id="uAvatar"><i class="ri-user-line"></i></div>
                    <h2 id="uAge">--</h2>
                    <div style="margin-top:10px; color:#64748b" id="uGender">--</div>
                    <div style="margin-top:5px; font-weight:700; color:var(--primary-dark)" id="uDuration">--</div>
                    
                    <div style="margin-top:30px; display:flex; gap:10px; justify-content:center;">
                        <button onclick="nav(-1)" style="padding:10px 20px; border-radius:20px; border:none; cursor:pointer;">Prev</button>
                        <div id="curIdx" style="padding:10px; font-weight:bold;">1</div>
                        <button onclick="nav(1)" style="padding:10px 20px; border-radius:20px; border:1px solid #ccc; cursor:pointer; background:white;">Next</button>
                    </div>
                </div>
                <div class="answer-area" id="detailContent"></div>
            </div>
        </div>
    </div>

    <!-- === VIEW 2: RESEARCH ANALYSIS (6 CHARTS + 1 TABLE) === -->
    <div id="view-stats" class="view-section">
        
        <div class="section-title"><i class="ri-table-line"></i> DEMOGRAPHIC ANALYSIS</div>
        
        <!-- 1. Table 3.1: Demographic Profiles -->
        <div class="research-card">
            <div class="chart-header">
                <span>Table 3.1: Demographic Profiles of the Participants (N=<span id="totalN">0</span>)</span>
            </div>
            <table class="demo-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Sub-category</th>
                        <th style="text-align:center;">Frequency (n)</th>
                        <th style="text-align:center;">Percentage (%)</th>
                    </tr>
                </thead>
                <tbody id="demoTableBody">
                    <!-- JS will render this -->
                </tbody>
            </table>
        </div>

        <div class="section-title"><i class="ri-bar-chart-box-line"></i> MOTIVATION ANALYSIS (RQ1)</div>

        <!-- 2. Chart 3.1: Item-level Analysis -->
        <div class="research-card">
            <div class="chart-header">Chart 3.1: Item-level Analysis of English Speaking Motivation (Mean Scores)</div>
            <canvas id="chartItemAnalysis" height="120"></canvas>
            <div style="font-size:13px; color:#64748b; margin-top:10px; font-style:italic; text-align:center;">
                Scale: 1 = Strongly Disagree, 5 = Strongly Agree
            </div>
        </div>

        <!-- 3. Chart 3.2: Intrinsic vs Extrinsic -->
        <div class="research-card">
            <div class="chart-header">Chart 3.2: Comparison Between Intrinsic and Extrinsic Motivation</div>
            <div style="width: 100%; max-width: 600px; margin: 0 auto;">
                <canvas id="chartInVsEx"></canvas>
            </div>
        </div>

        <div class="section-title"><i class="ri-mind-map"></i> FACTORS & SOLUTIONS (RQ2 & RQ3)</div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
            <!-- 4. Chart 3.3: Internal Factors -->
            <div class="research-card">
                <div class="chart-header">Chart 3.3: Psychological Barriers (Internal Factors)</div>
                <canvas id="chartInternal"></canvas>
            </div>

            <!-- 5. Chart 3.4: External Factors -->
            <div class="research-card">
                <div class="chart-header">Chart 3.4: Impact of Learning Environment (External)</div>
                <canvas id="chartExternal"></canvas>
            </div>
        </div>

        <!-- 6. Chart 3.5: Activities Preferences -->
        <div class="research-card">
            <div class="chart-header">Chart 3.5: Students' Preferences for Classroom Activities (RQ3)</div>
            <canvas id="chartActivities" height="100"></canvas>
        </div>

        <!-- 7. Chart 3.6: Feedback Categorization -->
        <div class="research-card">
            <div class="chart-header">Chart 3.6: Categorization of Student Feedback (Qualitative Analysis)</div>
            <canvas id="chartFeedback" height="120"></canvas>
        </div>

    </div>

    <script>
        // === PASTE LINK MỚI CỦA BẠN VÀO ĐÂY ===
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyg7-yAjQoN9NcU7VO5_iB1LHtLKBmWbGLrdKkpymuRcBEMoNLBBhVmYZVz_4ihhlcEzg/exec';

        // --- GLOBAL VARS ---
        let rawData = [], headers = [];
        let currentIndex = 0;

        // --- MAPS ---
        const likertKeys = {
            Intrinsic: ['A1', 'A2', 'A3'],
            Extrinsic: ['B1', 'B2', 'B3'],
            Internal: ['C1', 'C2', 'C3'],
            External: ['D1', 'D2', 'D3', 'D4']
        };

        const itemLabels = {
            A1: "A1. Express Ideas", A2: "A2. Enjoyment", A3: "A3. Culture/Media",
            B1: "B1. Marks/Rewards", B2: "B2. Expectations", B3: "B3. Career/Study",
            C1: "C1. Nervous/Shy", C2: "C2. Fear Mistakes", C3: "C3. Self-Belief",
            D1: "D1. Teachers", D2: "D2. Equipment", D3: "D3. Video Recording", D4: "D4. Group Work"
        };

        // --- HELPER FUNCTIONS ---
        // 1. Get Column Data by Fuzzy Name
        function getColData(prefix) {
            const idx = headers.findIndex(h => h.toString().trim().startsWith(prefix));
            if (idx === -1) return [];
            return rawData.map(r => r[idx]);
        }

        // 2. Count Frequencies for Table 3.1
        function getFrequency(colPrefix) {
            const data = getColData(colPrefix);
            const counts = {};
            data.forEach(x => { if(x) counts[x] = (counts[x] || 0) + 1; });
            return counts;
        }

        // 3. Calculate Mean (Average) for Charts
        function calculateMean(colPrefix) {
            const data = getColData(colPrefix);
            let sum = 0, count = 0;
            data.forEach(v => {
                const num = parseFloat(v);
                if (!isNaN(num)) { sum += num; count++; }
            });
            return count > 0 ? (sum / count).toFixed(2) : 0;
        }

        // --- INIT ---
        window.onload = async () => {
            try {
                const res = await fetch(scriptURL);
                const data = await res.json();
                
                headers = data[0];
                rawData = data.slice(1);
                
                document.getElementById('totalN').innerText = rawData.length;
                document.getElementById('loader').style.display = 'none';

                // Render Views
                renderDetail(rawData.length - 1);
                renderResearchAnalysis();

            } catch (err) {
                document.getElementById('loader').innerHTML = `<div style="color:red">ERROR LOADING DATA</div>`;
                console.error(err);
            }
        };

        function switchTab(t) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${t}`).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- RENDER DETAIL (SIMPLE VIEW) ---
        function renderDetail(idx) {
            if(idx < 0 || idx >= rawData.length) return;
            const row = rawData[idx];
            
            // Basic mapping for detail view... (simplified for brevity)
            const getVal = (k) => {
                const i = headers.findIndex(h => h.startsWith(k));
                return i !== -1 ? row[i] : '--';
            }
            document.getElementById('uAge').innerText = "Age: " + getVal('Age');
            document.getElementById('uGender').innerText = getVal('Gender');
            document.getElementById('uDuration').innerText = getVal('Duration');
            document.getElementById('curIdx').innerText = idx + 1;
            
            let html = '<div style="background:white; padding:15px; border-radius:10px;">';
            html += `<b>Activities:</b> ${getVal('Activities')}<br><br>`;
            html += `<b>Feedback:</b> "${getVal('Feedback')}"`;
            html += '</div>';
            document.getElementById('detailContent').innerHTML = html;
        }
        function nav(d) { currentIndex += d; renderDetail(currentIndex); }


        // --- MAIN: RESEARCH ANALYSIS RENDERER ---
        function renderResearchAnalysis() {
            Chart.defaults.font.family = 'Quicksand';
            Chart.defaults.color = '#334155';
            Chart.register(ChartDataLabels);

            // ==========================================
            // 1. TABLE 3.1: DEMOGRAPHICS
            // ==========================================
            const ageCounts = getFrequency('Age');
            const genderCounts = getFrequency('Gender');
            const durCounts = getFrequency('Duration');
            const total = rawData.length;

            function renderRow(cat, sub, counts) {
                const n = counts[sub] || 0;
                const pct = ((n / total) * 100).toFixed(1);
                return `<tr><td>${cat}</td><td>${sub}</td><td style="text-align:center;">${n}</td><td style="text-align:center;"><span class="badge">${pct}%</span></td></tr>`;
            }

            let tableHTML = '';
            // Age Rows
            tableHTML += renderRow('Age', '12-13', ageCounts);
            tableHTML += renderRow('', '14-15', ageCounts);
            tableHTML += renderRow('', '16', ageCounts);
            // Gender Rows
            tableHTML += renderRow('Gender', 'Male', genderCounts);
            tableHTML += renderRow('', 'Female', genderCounts);
            // Duration Rows
            tableHTML += renderRow('Duration', '<6m', durCounts);
            tableHTML += renderRow('', '6m-1y', durCounts);
            tableHTML += renderRow('', '>1y', durCounts);

            document.getElementById('demoTableBody').innerHTML = tableHTML;

            // ==========================================
            // 2. CHART 3.1: ITEM-LEVEL ANALYSIS (MEAN)
            // ==========================================
            const items = [...likertKeys.Intrinsic, ...likertKeys.Extrinsic];
            const itemMeans = items.map(k => calculateMean(k));

            new Chart(document.getElementById('chartItemAnalysis'), {
                type: 'bar',
                data: {
                    labels: items.map(k => itemLabels[k].split('. ')[0]), // A1, A2...
                    datasets: [{
                        label: 'Mean Score',
                        data: itemMeans,
                        backgroundColor: items.map((_, i) => i < 3 ? '#00c6ff' : '#0072ff'), // Light blue for Intrinsic, Dark for Extrinsic
                        borderRadius: 5
                    }]
                },
                options: {
                    plugins: { 
                        legend: { display: false },
                        datalabels: { anchor: 'end', align: 'end', color: '#0072ff', font: {weight: 'bold'} }
                    },
                    scales: { y: { min: 1, max: 5 } }
                }
            });

            // ==========================================
            // 3. CHART 3.2: INTRINSIC VS EXTRINSIC
            // ==========================================
            const meanIn = (itemMeans.slice(0,3).reduce((a,b)=>parseFloat(a)+parseFloat(b),0) / 3).toFixed(2);
            const meanEx = (itemMeans.slice(3,6).reduce((a,b)=>parseFloat(a)+parseFloat(b),0) / 3).toFixed(2);

            new Chart(document.getElementById('chartInVsEx'), {
                type: 'radar',
                data: {
                    labels: ['Intrinsic Motivation', 'Extrinsic Motivation', 'Confidence (Self-belief)', 'Fear/Anxiety'],
                    datasets: [{
                        label: 'Overall Mean',
                        // Logic: Intrinsic, Extrinsic, C3 (Belief), Avg(C1,C2) (Fear)
                        data: [meanIn, meanEx, calculateMean('C3'), (parseFloat(calculateMean('C1'))+parseFloat(calculateMean('C2')))/2],
                        backgroundColor: 'rgba(0, 198, 255, 0.2)',
                        borderColor: '#00c6ff',
                        pointBackgroundColor: '#0072ff'
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 5, pointLabels: { font: {size: 14} } } }
                }
            });

            // ==========================================
            // 4. CHART 3.3: INTERNAL FACTORS (PSYCHOLOGICAL)
            // ==========================================
            const internalItems = likertKeys.Internal; // C1, C2, C3
            const internalMeans = internalItems.map(k => calculateMean(k));

            new Chart(document.getElementById('chartInternal'), {
                type: 'bar',
                indexAxis: 'y',
                data: {
                    labels: internalItems.map(k => itemLabels[k]), // Full text labels
                    datasets: [{
                        label: 'Mean Score',
                        data: internalMeans,
                        backgroundColor: ['#ef4444', '#ef4444', '#10b981'], // Red for negative (Shy/Mistakes), Green for positive (Belief)
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    plugins: { legend: { display: false }, datalabels: { color: 'white', anchor:'center' } },
                    scales: { x: { min: 1, max: 5 } }
                }
            });

            // ==========================================
            // 5. CHART 3.4: EXTERNAL FACTORS (ENVIRONMENT)
            // ==========================================
            const externalItems = likertKeys.External; // D1...D4
            const externalMeans = externalItems.map(k => calculateMean(k));

            new Chart(document.getElementById('chartExternal'), {
                type: 'bar',
                data: {
                    labels: externalItems.map(k => k), // D1, D2...
                    datasets: [{
                        label: 'Mean Score',
                        data: externalMeans,
                        backgroundColor: '#f59e0b',
                        borderRadius: 5
                    }]
                },
                options: {
                    plugins: { 
                        datalabels: { anchor: 'end', align: 'end' },
                        tooltip: { callbacks: { title: (ctx) => itemLabels[ctx[0].label] } } // Show full text on hover
                    },
                    scales: { y: { min: 1, max: 5 } }
                }
            });

            // ==========================================
            // 6. CHART 3.5: ACTIVITIES PREFERENCES
            // ==========================================
            const actData = getColData('Activities');
            const actCounts = {};
            actData.forEach(s => {
                if(s) s.toString().split(', ').forEach(a => actCounts[a] = (actCounts[a]||0) + 1);
            });
            // Sort high to low
            const sortedActs = Object.entries(actCounts).sort((a,b) => b[1] - a[1]);

            new Chart(document.getElementById('chartActivities'), {
                type: 'bar',
                data: {
                    labels: sortedActs.map(x => x[0]),
                    datasets: [{
                        label: 'Frequency (Votes)',
                        data: sortedActs.map(x => x[1]),
                        backgroundColor: '#10b981',
                        borderRadius: 5
                    }]
                },
                options: {
                    plugins: { legend: {display:false}, datalabels: { anchor:'end', align:'end' } }
                }
            });

            // ==========================================
            // 7. CHART 3.6: FEEDBACK CATEGORIZATION (KEYWORD ANALYSIS)
            // ==========================================
            const feedbacks = getColData('Feedback').filter(f => f && f.length > 3);
            
            // Simple Keyword Matching Algorithm
            const categories = {
                "Request More Games": 0,
                "More Outdoor Activities": 0,
                "Teaching Method (Slower/Support)": 0,
                "Psychological (Shy/Afraid)": 0,
                "Positive/Satisfied": 0,
                "Others": 0
            };

            feedbacks.forEach(txt => {
                const t = txt.toLowerCase();
                if (t.includes('game') || t.includes('trò chơi')) categories["Request More Games"]++;
                else if (t.includes('outdoor') || t.includes('ngoài trời')) categories["More Outdoor Activities"]++;
                else if (t.includes('slow') || t.includes('chậm') || t.includes('teacher') || t.includes('cô')) categories["Teaching Method (Slower/Support)"]++;
                else if (t.includes('shy') || t.includes('ngại') || t.includes('sợ') || t.includes('confident')) categories["Psychological (Shy/Afraid)"]++;
                else if (t.includes('good') || t.includes('hay') || t.includes('thích') || t.includes('ổn')) categories["Positive/Satisfied"]++;
                else categories["Others"]++;
            });

            // Remove zero categories for cleaner chart
            const labelsFB = [], dataFB = [];
            for (let [k, v] of Object.entries(categories)) {
                if(v > 0) { labelsFB.push(k); dataFB.push(v); }
            }

            new Chart(document.getElementById('chartFeedback'), {
                type: 'bar',
                indexAxis: 'y',
                data: {
                    labels: labelsFB,
                    datasets: [{
                        label: 'Mention Frequency',
                        data: dataFB,
                        backgroundColor: '#8b5cf6',
                        borderRadius: 5
                    }]
                },
                options: {
                    plugins: { legend: {display:false}, datalabels: { anchor:'end', align:'end', color: '#8b5cf6' } }
                }
            });
        }
    </script>
</body>
</html>
